<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MRSM Bentong IoT</title>
  <link rel="icon" type="image/jpeg" href="https://upload.wikimedia.org/wikipedia/ms/3/3b/MRSM_Logo.jpg">
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Outfit', sans-serif; }
    .glass-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); }
    .scanner-ring { animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse-ring { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.05); opacity: 1; } }
    .scan-line { animation: scan 2s ease-in-out infinite; }
    @keyframes scan { 0%, 100% { transform: translateY(-100%); } 50% { transform: translateY(100%); } }
    .float-animation { animation: float 6s ease-in-out infinite; }
    @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
    input:focus, select:focus { outline: none; box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3); }
    .status-active { color: #10b981; }
    .status-overdue { color: #ef4444; }
    .status-returned { color: #6b7280; }
    .tab-active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s ease; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3); }
    .btn-secondary { background: #f8fafc; border: 1px solid #e2e8f0; transition: all 0.3s ease; }
    .btn-secondary:hover { background: #f1f5f9; border-color: #cbd5e1; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full bg-gradient-to-br from-slate-50 via-white to-indigo-50 overflow-auto">
  <div id="app" class="min-h-full w-full flex flex-col">
   <div class="fixed inset-0 overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -right-40 w-80 h-80 bg-indigo-100 rounded-full opacity-50 blur-3xl"></div>
    <div class="absolute -bottom-40 -left-40 w-96 h-96 bg-purple-100 rounded-full opacity-50 blur-3xl"></div>
    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-gradient-to-r from-indigo-50 to-purple-50 rounded-full opacity-30 blur-3xl"></div>
   </div>
   <div class="relative z-10 flex-1 p-4 md:p-8">
    <header class="text-center mb-8">
     <div class="flex flex-col items-center gap-4 mb-6">
      <img src="https://upload.wikimedia.org/wikipedia/ms/3/3b/MRSM_Logo.jpg" alt="MRSM Logo" class="w-20 h-20 object-contain" loading="lazy" onerror="console.error('Logo failed to load:', this.src); this.style.display='none';">
      <div class="text-center">
       <h1 id="library-title" class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">MRSM Bentong IoT</h1>
       <p id="subtitle" class="text-slate-500 text-sm font-light tracking-wide mt-2">Smart Library Management System</p>
      </div>
     </div>
    </header>
    <nav class="flex justify-center mb-8">
     <div class="glass-card rounded-2xl p-1.5 flex gap-1">
      <button onclick="switchTab('scan')" id="tab-scan" class="tab-active px-6 py-3 rounded-xl font-medium text-sm transition-all flex items-center gap-2">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0115.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4" />
       </svg> RFID Scan </button><button onclick="switchTab('manual')" id="tab-manual" class="px-6 py-3 rounded-xl font-medium text-sm text-slate-600 hover:bg-slate-100 transition-all flex items-center gap-2">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
       </svg> Manual Entry </button><button onclick="switchTab('records')" id="tab-records" class="px-6 py-3 rounded-xl font-medium text-sm text-slate-600 hover:bg-slate-100 transition-all flex items-center gap-2">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
       </svg> Records </button>
     </div>
    </nav>
    <section id="section-scan" class="max-w-6xl mx-auto">
     <div class="grid md:grid-cols-2 gap-6">
      <div class="glass-card rounded-3xl p-6 float-animation" style="animation-delay: 0s;">
       <div class="text-center mb-6">
        <div class="inline-flex items-center gap-2 px-4 py-1.5 bg-indigo-50 rounded-full mb-4">
         <div class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></div><span class="text-xs font-medium text-indigo-600">Student ID</span>
        </div>
        <h3 class="text-lg font-semibold text-slate-800">Scan Student Card</h3>
        <p id="welcome-message" class="text-slate-500 text-sm">Tap your card on the reader</p>
       </div>
       <div class="relative w-48 h-48 mx-auto mb-6">
        <div class="absolute inset-0 rounded-full border-4 border-indigo-100 scanner-ring"></div>
        <div class="absolute inset-3 rounded-full border-2 border-indigo-200 scanner-ring" style="animation-delay: 0.5s;"></div>
        <div class="absolute inset-6 rounded-full bg-gradient-to-br from-indigo-50 to-purple-50 flex items-center justify-center">
         <svg class="w-16 h-16 text-indigo-400" fill="none" stroke="currentColor" viewbox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2" />
         </svg>
        </div>
       </div>
       <div class="space-y-3">
        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
         <span class="text-xs font-mono text-slate-500">Maktab ID</span> <span id="scan-borrower-id" class="text-sm font-mono font-medium text-slate-700">‚Äî</span>
        </div>
        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
         <span class="text-xs font-mono text-slate-500">Name</span> <span id="scan-borrower-name" class="text-sm font-medium text-slate-700">‚Äî</span>
        </div>
        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
         <span class="text-xs font-mono text-slate-500">Class</span> <span id="scan-borrower-class" class="text-sm font-medium text-slate-700">‚Äî</span>
        </div>
        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
         <span class="text-xs font-mono text-slate-500">RFID UID (HEX)</span> <span id="scan-borrower-uid" class="text-sm font-mono text-slate-700">‚Äî</span>
        </div>
       </div>
      </div>
      <div class="glass-card rounded-3xl p-6 float-animation" style="animation-delay: 0.3s;">
       <div class="text-center mb-6">
        <div class="inline-flex items-center gap-2 px-4 py-1.5 bg-purple-50 rounded-full mb-4">
         <div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div><span class="text-xs font-medium text-purple-600">Book ISBN</span>
        </div>
        <h3 class="text-lg font-semibold text-slate-800">Scan Book RFID</h3>
        <p class="text-slate-500 text-sm">Place book on the scanner</p>
       </div>
       <div class="relative w-48 h-48 mx-auto mb-6">
        <div class="absolute inset-0 rounded-3xl border-4 border-purple-100 scanner-ring"></div>
        <div class="absolute inset-3 rounded-2xl border-2 border-purple-200 scanner-ring" style="animation-delay: 0.5s;"></div>
        <div class="absolute inset-6 rounded-xl bg-gradient-to-br from-purple-50 to-pink-50 flex items-center justify-center overflow-hidden">
         <div class="absolute inset-0 bg-gradient-to-b from-purple-200/50 to-transparent h-1/2 scan-line"></div>
         <svg class="w-16 h-16 text-purple-400 relative z-10" fill="none" stroke="currentColor" viewbox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
         </svg>
        </div>
       </div>
       <div class="space-y-3">
        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
         <span class="text-xs font-mono text-slate-500">ISBN</span> <span id="scan-book-isbn" class="text-sm font-mono font-medium text-slate-700">‚Äî</span>
        </div>
        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
         <span class="text-xs font-mono text-slate-500">Title</span> <span id="scan-book-title" class="text-sm font-medium text-slate-700">‚Äî</span>
        </div>
        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
         <span class="text-xs font-mono text-slate-500">Author</span> <span id="scan-book-author" class="text-sm font-medium text-slate-700">‚Äî</span>
        </div>
        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
         <span class="text-xs font-mono text-slate-500">RFID UID (HEX)</span> <span id="scan-book-uid" class="text-sm font-mono text-slate-700">‚Äî</span>
        </div>
       </div>
      </div>
     </div>
     <div class="grid md:grid-cols-2 gap-6 mt-6">
      <button onclick="simulateStudentScan()" class="btn-primary text-white py-3 rounded-xl font-medium text-sm"> Simulate Card Scan </button> <button onclick="simulateBookScan()" class="btn-primary text-white py-3 rounded-xl font-medium text-sm"> Simulate Book Scan </button>
     </div>
     <div class="mt-6 glass-card rounded-3xl p-6">
      <div class="flex flex-col md:flex-row items-center justify-between gap-4">
       <div>
        <h3 class="font-semibold text-slate-800">Transaction Processing</h3>
        <p class="text-sm text-slate-500">ISO 8601 timestamp format</p>
       </div>
       <div class="flex gap-3">
        <button onclick="processLoan()" id="btn-loan" class="btn-primary text-white px-8 py-3 rounded-xl font-medium text-sm disabled:opacity-50" disabled> üìö Create Loan </button> <button onclick="processReturn()" id="btn-return" class="btn-secondary text-slate-700 px-8 py-3 rounded-xl font-medium text-sm disabled:opacity-50" disabled> ‚Ü©Ô∏è Create Return </button>
       </div>
      </div>
     </div>
    </section>
    <section id="section-manual" class="max-w-2xl mx-auto hidden">
     <div class="glass-card rounded-3xl p-8">
      <div class="text-center mb-8">
       <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl mb-4">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
        </svg>
       </div>
       <h2 class="text-xl font-bold text-slate-800">Manual Transaction Entry</h2>
       <p class="text-slate-500 text-xs mt-1">Complete Transaction Data Entry Form</p>
      </div>
      <form id="manual-form" onsubmit="handleManualSubmit(event)" class="space-y-6">
       <div>
        <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">üìö Book Information</label>
        <div class="grid md:grid-cols-2 gap-4">
         <div>
          <label for="book-isbn" class="block text-sm font-medium text-slate-700 mb-2">ISBN (Format: XXX-X-XXXXXX-XX-X)</label> <input type="text" id="book-isbn" name="book_isbn" placeholder="978-0-123456-78-9" required class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white/50 text-slate-800 placeholder-slate-400 transition-all">
         </div>
         <div>
          <label for="book-title" class="block text-sm font-medium text-slate-700 mb-2">Book Title</label> <input type="text" id="book-title" name="book_title" placeholder="Enter book title" required class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white/50 text-slate-800 placeholder-slate-400 transition-all">
         </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mt-4">
         <div>
          <label for="book-author" class="block text-sm font-medium text-slate-700 mb-2">Author</label> <input type="text" id="book-author" name="book_author" placeholder="Enter author name" required class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white/50 text-slate-800 placeholder-slate-400 transition-all">
         </div>
         <div>
          <label for="book-rfid-uid" class="block text-sm font-medium text-slate-700 mb-2">RFID UID (Hexadecimal Format)</label> <input type="text" id="book-rfid-uid" name="book_rfid_uid" placeholder="E.g., 04D5B94E9A3D21" required class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white/50 text-slate-800 placeholder-slate-400 transition-all font-mono text-sm">
         </div>
        </div>
       </div>
       <div>
        <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">üë§ Borrower Information</label>
        <div class="grid md:grid-cols-2 gap-4">
         <div>
          <label for="borrower-id" class="block text-sm font-medium text-slate-700 mb-2">Maktab ID</label> <input type="text" id="borrower-id" name="borrower_id" placeholder="MB2024001" required class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white/50 text-slate-800 placeholder-slate-400 transition-all font-mono">
         </div>
         <div>
          <label for="borrower-name" class="block text-sm font-medium text-slate-700 mb-2">Full Name</label> <input type="text" id="borrower-name" name="borrower_name" placeholder="Enter borrower name" required class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white/50 text-slate-800 placeholder-slate-400 transition-all">
         </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mt-4">
         <div>
          <label for="borrower-class" class="block text-sm font-medium text-slate-700 mb-2">Class</label> <select id="borrower-class" name="borrower_class" required class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white/50 text-slate-800 transition-all"> <option value="">Select class</option> <option value="4 Adil">4 Adil</option> <option value="4 Bestari">4 Bestari</option> <option value="4 Cemerlang">4 Cemerlang</option> <option value="5 Adil">5 Adil</option> <option value="5 Bestari">5 Bestari</option> <option value="5 Cemerlang">5 Cemerlang</option> </select>
         </div>
         <div>
          <label for="borrower-rfid-uid" class="block text-sm font-medium text-slate-700 mb-2">Borrower RFID UID (Hexadecimal)</label> <input type="text" id="borrower-rfid-uid" name="borrower_rfid_uid" placeholder="E.g., 04C2A54F7B1E08" required class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white/50 text-slate-800 placeholder-slate-400 transition-all font-mono text-sm">
         </div>
        </div>
       </div>
       <div>
        <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">üìÖ Transaction</label>
        <div class="grid md:grid-cols-2 gap-4">
         <div>
          <label for="transaction-type" class="block text-sm font-medium text-slate-700 mb-2">Transaction Type</label> <select id="transaction-type" name="transaction_type" required class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white/50 text-slate-800 transition-all"> <option value="">Select type</option> <option value="LOAN">Loan (Checkout)</option> <option value="RETURN">Return</option> <option value="RENEWAL">Renewal</option> </select>
         </div>
         <div>
          <label for="loan-period" class="block text-sm font-medium text-slate-700 mb-2">Loan Period (days)</label> <input type="number" id="loan-period" name="loan_period" placeholder="14" value="14" min="1" max="365" required class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white/50 text-slate-800 placeholder-slate-400 transition-all">
         </div>
        </div>
       </div>
       <div class="flex gap-3 pt-4">
        <button type="submit" class="flex-1 btn-primary text-white py-4 rounded-xl font-medium text-sm"> ‚úì Submit Transaction </button> <button type="button" onclick="clearManualForm()" class="btn-secondary text-slate-600 px-6 py-4 rounded-xl font-medium text-sm"> Clear </button>
       </div>
      </form>
     </div>
    </section>
    <section id="section-records" class="max-w-6xl mx-auto hidden">
     <div class="glass-card rounded-3xl p-6 mb-6">
      <div class="flex flex-col md:flex-row items-center justify-between gap-4">
       <div>
        <h2 class="text-xl font-bold text-slate-800">Transaction Records</h2>
        <p class="text-slate-500 text-sm">View and manage all transactions</p>
       </div>
       <div class="flex items-center gap-4">
        <div class="relative">
         <input type="text" id="search-input" oninput="filterRecords()" placeholder="Search records..." class="pl-10 pr-4 py-2.5 border border-slate-200 rounded-xl bg-white/50 text-sm text-slate-800 placeholder-slate-400 w-64">
         <svg class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewbox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
         </svg>
        </div><select id="filter-status" onchange="filterRecords()" class="px-4 py-2.5 border border-slate-200 rounded-xl bg-white/50 text-sm text-slate-700"> <option value="">All Status</option> <option value="ACTIVE">Active</option> <option value="OVERDUE">Overdue</option> <option value="RETURNED">Returned</option> </select>
       </div>
      </div>
     </div>
     <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="glass-card rounded-2xl p-4">
       <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
         <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
         </svg>
        </div>
        <div>
         <p class="text-2xl font-bold text-slate-800" id="stat-total">0</p>
         <p class="text-xs text-slate-500">Total Transactions</p>
        </div>
       </div>
      </div>
      <div class="glass-card rounded-2xl p-4">
       <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center">
         <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
         </svg>
        </div>
        <div>
         <p class="text-2xl font-bold text-emerald-600" id="stat-active">0</p>
         <p class="text-xs text-slate-500">Active Loans</p>
        </div>
       </div>
      </div>
      <div class="glass-card rounded-2xl p-4">
       <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center">
         <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
         </svg>
        </div>
        <div>
         <p class="text-2xl font-bold text-red-600" id="stat-overdue">0</p>
         <p class="text-xs text-slate-500">Overdue</p>
        </div>
       </div>
      </div>
      <div class="glass-card rounded-2xl p-4">
       <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center">
         <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
         </svg>
        </div>
        <div>
         <p class="text-2xl font-bold text-slate-600" id="stat-returned">0</p>
         <p class="text-xs text-slate-500">Returned</p>
        </div>
       </div>
      </div>
     </div>
     <div class="glass-card rounded-3xl overflow-hidden">
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead>
         <tr class="bg-slate-50/50">
          <th class="text-left px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Transaction ID</th>
          <th class="text-left px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Book (ISBN)</th>
          <th class="text-left px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Maktab ID</th>
          <th class="text-left px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Transaction Date</th>
          <th class="text-left px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Due Date</th>
          <th class="text-left px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Status</th>
          <th class="text-left px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Action</th>
         </tr>
        </thead>
        <tbody id="records-tbody">
         <tr>
          <td colspan="7" class="px-6 py-12 text-center text-slate-400">
           <svg class="w-12 h-12 mx-auto mb-3 text-slate-300" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
           </svg><p>No records found</p><p class="text-sm">Start by creating a transaction</p></td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </section>
   </div>
   <footer class="relative z-10 border-t border-slate-200/30 bg-white/40 backdrop-blur-sm mt-8">
    <div class="max-w-6xl mx-auto px-4 md:px-8 py-6">
     <div class="flex flex-col md:flex-row items-center justify-between gap-4 text-center md:text-left">
      <p class="text-sm text-slate-600">¬© 2024 MRSM Bentong Smart Library System</p>
      <div class="flex items-center gap-2 text-xs text-slate-500">
       <svg class="w-3 h-3" fill="currentColor" viewbox="0 0 24 24">
        <circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.5" />
       </svg><span>ISO 2108 ‚Ä¢ ISO 8601 ‚Ä¢ ISO 20957 Compliance</span>
      </div>
     </div>
    </div>
   </footer>
   <div id="toast" class="fixed bottom-6 right-6 transform translate-y-20 opacity-0 transition-all duration-300 z-50">
    <div class="glass-card rounded-2xl px-6 py-4 shadow-xl flex items-center gap-3">
     <div id="toast-icon" class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center">
      <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
     </div>
     <p id="toast-message" class="font-medium text-slate-800">Success!</p>
    </div>
   </div>
   <div id="confirmation-modal" class="fixed inset-0 bg-black/30 hidden flex items-center justify-center z-50">
    <div class="glass-card rounded-3xl p-8 max-w-md mx-4">
     <h3 id="modal-title" class="text-xl font-bold text-slate-800 mb-3">Confirm Transaction</h3>
     <p id="modal-message" class="text-slate-600 mb-6"></p>
     <div class="flex gap-3">
      <button onclick="closeModal()" class="flex-1 btn-secondary rounded-xl py-2">Cancel</button> <button onclick="confirmAction()" class="flex-1 btn-primary text-white rounded-xl py-2">Confirm</button>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      library_title: 'MRSM Bentong IoT',
      subtitle: 'Smart Library Management System',
      welcome_message: 'Scan your card to begin'
    };

    let config = { ...defaultConfig };
    let records = [];
    let filteredRecords = [];
    let scannedBorrower = null;
    let scannedBook = null;
    let pendingConfirmCallback = null;

    const sampleBorrowers = [
      { id: 'MB2024001', name: 'Abdul Nagib', class: '5 Adil', rfid_uid: '04D5B94E9A3D21' },
      { id: 'MB2024002', name: 'Nur Zafirah', class: '5 Bestari', rfid_uid: '04C2A54F7B1E08' },
      { id: 'MB2024003', name: 'Siti Nurhaliza', class: '4 Cemerlang', rfid_uid: '04E1F2C3D4E5F6' }
    ];

    const sampleBooks = [
      { isbn: '978-0-123456-78-9', title: 'Bahasa Melayu Sempurna', author: 'Dewan Bahasa dan Pustaka', rfid_uid: '04A1B2C3D4E5F6' },
      { isbn: '978-0-987654-32-1', title: 'Physics: Fundamentals and Applications', author: 'Raymond A. Serway', rfid_uid: '04F6E5D4C3B2A1' },
      { isbn: '978-0-111222-33-4', title: 'IoT Engineering: Design and Implementation', author: 'Salvatore Distefano', rfid_uid: '04D0E1F2A3B4C5' }
    ];

    const dataHandler = {
      onDataChanged(data) {
        records = data;
        updateStats();
        filterRecords();
      }
    };

    async function initApp() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: (cfg) => {
            config = { ...defaultConfig, ...cfg };
            applyConfig();
          },
          mapToCapabilities: () => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['library_title', cfg.library_title || defaultConfig.library_title],
            ['subtitle', cfg.subtitle || defaultConfig.subtitle],
            ['welcome_message', cfg.welcome_message || defaultConfig.welcome_message]
          ])
        });
      }

      if (window.dataSdk) {
        await window.dataSdk.init(dataHandler);
      }

      applyConfig();
    }

    function applyConfig() {
      document.getElementById('library-title').textContent = config.library_title || defaultConfig.library_title;
      document.getElementById('subtitle').textContent = config.subtitle || defaultConfig.subtitle;
      document.getElementById('welcome-message').textContent = config.welcome_message || defaultConfig.welcome_message;
    }

    function switchTab(tab) {
      const tabs = ['scan', 'manual', 'records'];
      tabs.forEach(t => {
        document.getElementById(`tab-${t}`).classList.remove('tab-active', 'text-white');
        document.getElementById(`tab-${t}`).classList.add('text-slate-600');
        document.getElementById(`section-${t}`).classList.add('hidden');
      });

      document.getElementById(`tab-${tab}`).classList.add('tab-active', 'text-white');
      document.getElementById(`tab-${tab}`).classList.remove('text-slate-600');
      document.getElementById(`section-${tab}`).classList.remove('hidden');
    }

    function simulateStudentScan() {
      const borrower = sampleBorrowers[Math.floor(Math.random() * sampleBorrowers.length)];
      scannedBorrower = borrower;
      document.getElementById('scan-borrower-id').textContent = borrower.id;
      document.getElementById('scan-borrower-name').textContent = borrower.name;
      document.getElementById('scan-borrower-class').textContent = borrower.class;
      document.getElementById('scan-borrower-uid').textContent = borrower.rfid_uid;
      updateActionButtons();
      showToast('Student card scanned successfully', 'success');
    }

    function simulateBookScan() {
      const book = sampleBooks[Math.floor(Math.random() * sampleBooks.length)];
      scannedBook = book;
      document.getElementById('scan-book-isbn').textContent = book.isbn;
      document.getElementById('scan-book-title').textContent = book.title;
      document.getElementById('scan-book-author').textContent = book.author;
      document.getElementById('scan-book-uid').textContent = book.rfid_uid;
      updateActionButtons();
      showToast('Book RFID scanned successfully', 'success');
    }

    function updateActionButtons() {
      const canProcess = scannedBorrower && scannedBook;
      document.getElementById('btn-loan').disabled = !canProcess;
      document.getElementById('btn-return').disabled = !canProcess;
    }

    async function processLoan() {
      if (!scannedBorrower || !scannedBook) {
        showToast('Please scan both student card and book', 'error');
        return;
      }
      if (records.length >= 999) {
        showToast('Record limit reached (999)', 'error');
        return;
      }

      const now = new Date();
      const dueDate = new Date(now);
      dueDate.setDate(dueDate.getDate() + 14);

      const loanData = {
        transaction_id: `TXN-${Date.now()}`,
        transaction_type: 'LOAN',
        book_isbn: scannedBook.isbn,
        book_title: scannedBook.title,
        book_author: scannedBook.author,
        book_rfid_uid: scannedBook.rfid_uid,
        borrower_id: scannedBorrower.id,
        borrower_name: scannedBorrower.name,
        borrower_class: scannedBorrower.class,
        borrower_rfid_uid: scannedBorrower.rfid_uid,
        transaction_timestamp: now.toISOString(),
        due_date: dueDate.toISOString(),
        return_timestamp: '',
        transaction_status: 'ACTIVE'
      };

      showConfirmation(
        'Confirm Loan Transaction',
        `Loan "${scannedBook.title}" to ${scannedBorrower.name}?\nDue: ${dueDate.toISOString().split('T')[0]}`,
        async () => {
          if (!window.dataSdk) {
            showToast('Data SDK not available', 'error');
            return;
          }
          const result = await window.dataSdk.create(loanData);
          if (result.isOk) {
            showToast('Loan transaction created successfully', 'success');
            clearScans();
          } else {
            showToast('Failed to create loan transaction', 'error');
          }
        }
      );
    }

    async function processReturn() {
      if (!scannedBorrower || !scannedBook) {
        showToast('Please scan both student card and book', 'error');
        return;
      }

      const activeLoan = records.find(r =>
        r.book_rfid_uid === scannedBook.rfid_uid &&
        r.borrower_rfid_uid === scannedBorrower.rfid_uid &&
        r.transaction_status === 'ACTIVE'
      );

      if (!activeLoan) {
        showToast('No active loan found for this book and student', 'error');
        return;
      }

      const returnData = {
        ...activeLoan,
        transaction_status: 'RETURNED',
        return_timestamp: new Date().toISOString()
      };

      showConfirmation(
        'Confirm Return Transaction',
        `Return "${scannedBook.title}" from ${scannedBorrower.name}?`,
        async () => {
          if (!window.dataSdk) {
            showToast('Data SDK not available', 'error');
            return;
          }
          const result = await window.dataSdk.update(returnData);
          if (result.isOk) {
            showToast('Return transaction created successfully', 'success');
            clearScans();
          } else {
            showToast('Failed to process return transaction', 'error');
          }
        }
      );
    }

    function clearScans() {
      scannedBorrower = null;
      scannedBook = null;
      document.getElementById('scan-borrower-id').textContent = '‚Äî';
      document.getElementById('scan-borrower-name').textContent = '‚Äî';
      document.getElementById('scan-borrower-class').textContent = '‚Äî';
      document.getElementById('scan-borrower-uid').textContent = '‚Äî';
      document.getElementById('scan-book-isbn').textContent = '‚Äî';
      document.getElementById('scan-book-title').textContent = '‚Äî';
      document.getElementById('scan-book-author').textContent = '‚Äî';
      document.getElementById('scan-book-uid').textContent = '‚Äî';
      updateActionButtons();
    }

    async function handleManualSubmit(e) {
      e.preventDefault();
      if (records.length >= 999) {
        showToast('Record limit reached', 'error');
        return;
      }

      const formData = new FormData(e.target);
      const type = formData.get('transaction_type');
      const now = new Date();
      const loanPeriod = parseInt(formData.get('loan_period')) || 14;
      const dueDate = new Date(now);
      dueDate.setDate(dueDate.getDate() + loanPeriod);

      const transaction = {
        transaction_id: `TXN-${Date.now()}`,
        transaction_type: type,
        book_isbn: formData.get('book_isbn'),
        book_title: formData.get('book_title'),
        book_author: formData.get('book_author'),
        book_rfid_uid: formData.get('book_rfid_uid'),
        borrower_id: formData.get('borrower_id'),
        borrower_name: formData.get('borrower_name'),
        borrower_class: formData.get('borrower_class'),
        borrower_rfid_uid: formData.get('borrower_rfid_uid'),
        transaction_timestamp: now.toISOString(),
        due_date: type === 'RETURN' ? '' : dueDate.toISOString(),
        return_timestamp: type === 'RETURN' ? now.toISOString() : '',
        transaction_status: type === 'RETURN' ? 'RETURNED' : 'ACTIVE'
      };

      if (window.dataSdk) {
        const result = await window.dataSdk.create(transaction);
        if (result.isOk) {
          showToast('Transaction recorded successfully', 'success');
          e.target.reset();
        } else {
          showToast('Failed to record transaction', 'error');
        }
      }
    }

    function clearManualForm() {
      document.getElementById('manual-form').reset();
    }

    function updateStats() {
      const now = new Date();
      let active = 0, overdue = 0, returned = 0;

      records.forEach(r => {
        if (r.transaction_status === 'RETURNED') {
          returned++;
        } else if (new Date(r.due_date) < now) {
          overdue++;
        } else {
          active++;
        }
      });

      document.getElementById('stat-total').textContent = records.length;
      document.getElementById('stat-active').textContent = active;
      document.getElementById('stat-overdue').textContent = overdue;
      document.getElementById('stat-returned').textContent = returned;
    }

    function filterRecords() {
      const search = document.getElementById('search-input').value.toLowerCase();
      const statusFilter = document.getElementById('filter-status').value;
      const now = new Date();

      filteredRecords = records.filter(r => {
        const matches = !search ||
          r.book_isbn.toLowerCase().includes(search) ||
          r.book_title.toLowerCase().includes(search) ||
          r.borrower_id.toLowerCase().includes(search) ||
          r.borrower_name.toLowerCase().includes(search);

        let currentStatus = r.transaction_status;
        if (r.transaction_status === 'ACTIVE' && new Date(r.due_date) < now) {
          currentStatus = 'OVERDUE';
        }
        const statusMatches = !statusFilter || currentStatus === statusFilter;

        return matches && statusMatches;
      });

      renderRecords();
    }

    function renderRecords() {
      const tbody = document.getElementById('records-tbody');
      const now = new Date();

      if (filteredRecords.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-slate-400"><svg class="w-12 h-12 mx-auto mb-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg><p>No records found</p></td></tr>';
        return;
      }

      tbody.innerHTML = filteredRecords.map(r => {
        let status = r.transaction_status;
        let statusClass = 'status-active';
        if (r.transaction_status === 'RETURNED') {
          statusClass = 'status-returned';
        } else if (new Date(r.due_date) < now) {
          statusClass = 'status-overdue';
          status = 'OVERDUE';
        }

        return `
          <tr class="border-t border-slate-100 hover:bg-slate-50/50 transition-colors">
            <td class="px-6 py-4"><span class="font-mono text-sm font-medium text-slate-700">${r.transaction_id}</span></td>
            <td class="px-6 py-4"><p class="font-mono text-sm text-slate-800">${r.book_isbn}</p><p class="text-xs text-slate-500">${r.book_title}</p></td>
            <td class="px-6 py-4"><p class="font-medium text-slate-800">${r.borrower_id}</p><p class="text-xs text-slate-500">${r.borrower_name}</p></td>
            <td class="px-6 py-4"><span class="font-mono text-sm text-slate-700">${r.transaction_timestamp.split('T')[0]}</span></td>
            <td class="px-6 py-4"><span class="text-sm text-slate-700">${r.due_date ? r.due_date.split('T')[0] : '‚Äî'}</span></td>
            <td class="px-6 py-4"><span class="${statusClass} inline-block px-3 py-1 bg-slate-100 rounded-lg text-xs font-semibold uppercase">${status}</span></td>
            <td class="px-6 py-4">
              ${r.transaction_status === 'ACTIVE' ? `<button onclick="markReturned('${r.__backendId}')" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">Return</button>` : '‚Äî'}
            </td>
          </tr>
        `;
      }).join('');
    }

    async function markReturned(backendId) {
      const record = records.find(r => r.__backendId === backendId);
      if (!record) return;

      const updated = {
        ...record,
        transaction_status: 'RETURNED',
        return_timestamp: new Date().toISOString()
      };

      if (window.dataSdk) {
        const result = await window.dataSdk.update(updated);
        if (result.isOk) {
          showToast('Return transaction created', 'success');
        } else {
          showToast('Failed to process return', 'error');
        }
      }
    }

    function showConfirmation(title, message, callback) {
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-message').textContent = message;
      pendingConfirmCallback = callback;
      document.getElementById('confirmation-modal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('confirmation-modal').classList.add('hidden');
      pendingConfirmCallback = null;
    }

    async function confirmAction() {
      if (typeof pendingConfirmCallback === 'function') {
        await pendingConfirmCallback();
      }
      closeModal();
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      const toastIcon = document.getElementById('toast-icon');

      toastMessage.textContent = message;

      if (type === 'success') {
        toastIcon.className = 'w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center';
        toastIcon.innerHTML = '<svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
      } else {
        toastIcon.className = 'w-8 h-8 rounded-full bg-red-100 flex items-center justify-center';
        toastIcon.innerHTML = '<svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
      }

      toast.classList.remove('translate-y-20', 'opacity-0');
      toast.classList.add('translate-y-0', 'opacity-100');

      setTimeout(() => {
        toast.classList.add('translate-y-20', 'opacity-0');
        toast.classList.remove('translate-y-0', 'opacity-100');
      }, 3000);
    }

    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cedaa6926ff494c',t:'MTc3MTI1MTQxNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
